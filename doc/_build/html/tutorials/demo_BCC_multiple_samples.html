<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BCC Multiple Samples &mdash; scATAnno: Automated Cell Type Annotation for single-cell ATAC-seq Data  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/nbsphinx-code-cells.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> scATAnno: Automated Cell Type Annotation for single-cell ATAC-seq Data
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">About scATAnno</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Atlases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference_details.html">Reference Atlas</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Workflow Details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workflow_details.html">Prepare Reference Atlas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../workflow_details2.html">Pipeline Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Algorithms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../algorithm.html">Dimension reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithm.html#cell-type-assignment">Cell-type Assignment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials.html">Case Study Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Tutorials</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">scATAnno: Automated Cell Type Annotation for single-cell ATAC-seq Data</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>BCC Multiple Samples</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/demo_BCC_multiple_samples.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="BCC-Multiple-Samples">
<h1>BCC Multiple Samples<a class="headerlink" href="#BCC-Multiple-Samples" title="Permalink to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span> <span class="c1"># Anndata version must &gt; 0.8</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">scATAnno</span>
<span class="kn">from</span> <span class="nn">scATAnno.SnapATAC2_spectral</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scATAnno.SnapATAC2_tools</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scATAnno.SnapATAC2_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">scATAnno</span> <span class="kn">import</span> <span class="n">scATAnno_preprocess</span>
<span class="kn">from</span> <span class="nn">scATAnno</span> <span class="kn">import</span> <span class="n">scATAnno_assignment</span>
<span class="kn">from</span> <span class="nn">scATAnno</span> <span class="kn">import</span> <span class="n">scATAnno_integration</span>
<span class="kn">from</span> <span class="nn">scATAnno</span> <span class="kn">import</span> <span class="n">scATAnno_plotting</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="n">default_28</span> <span class="o">=</span> <span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">get_palettes</span><span class="p">(</span><span class="s2">&quot;default28&quot;</span><span class="p">)</span>
<span class="n">default_102</span> <span class="o">=</span> <span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">get_palettes</span><span class="p">(</span><span class="s2">&quot;default102&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Part-I:-First-round-annotation---Apply-Healthy-Adult-reference-atlas-to-BCC-tumor-samples">
<h2>Part I: First round annotation - Apply Healthy Adult reference atlas to BCC tumor samples<a class="headerlink" href="#Part-I:-First-round-annotation---Apply-Healthy-Adult-reference-atlas-to-BCC-tumor-samples" title="Permalink to this heading"></a></h2>
<p>Download reference data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !wget &quot;https://www.dropbox.com/s/3ezp2t6gw6hw21v/Healthy_Adult_reference_atlas.h5ad?dl=1&quot;</span>
</pre></div>
</div>
</div>
<p>Download query data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !wget &quot;https://www.dropbox.com/sh/dwn0ynon4bzzj4t/AAB8ei6223oIWC14ry_lNdSma?dl=1&quot;</span>
</pre></div>
</div>
</div>
<p>We first apply healthy adult reference atlas to two BCC samples. We load reference atlas data and BCC query data with healthy adult reference peak as feature input. Reference atlas is stored as h5ad AnnData in the data directory; query data is imported as MTX and TSV files from QuickATAC output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;scATAnno-main&quot;</span><span class="p">)</span>

<span class="n">output_name</span> <span class="o">=</span> <span class="s2">&quot;BCC_samples&quot;</span>
<span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;case_study&quot;</span><span class="p">,</span> <span class="n">output_name</span><span class="p">)</span>

<span class="n">reference_data_path</span> <span class="o">=</span> <span class="s2">&quot;data/Reference/Healthy_Adult_reference_atlas.h5ad&quot;</span>
<span class="n">reference_data</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">load_reference_data</span><span class="p">(</span><span class="n">reference_data_path</span><span class="p">)</span>
<span class="n">SU007_Total_Post</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">import_query_data</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/BCC_samples/SU007_Total_Post_vHealthyAdult&#39;</span><span class="p">,</span>
                                    <span class="n">mtx_file</span> <span class="o">=</span> <span class="s1">&#39;matrix.mtx.gz&#39;</span><span class="p">,</span>
                                    <span class="n">cells_file</span> <span class="o">=</span> <span class="s1">&#39;barcodes.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">features_file</span> <span class="o">=</span> <span class="s1">&#39;features.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">variable_prefix</span> <span class="o">=</span> <span class="s2">&quot;SU007_Total_Post&quot;</span><span class="p">,</span>
                                    <span class="n">celltype_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span><span class="p">,</span>
                                    <span class="n">add_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SU010_Total_Pre</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">import_query_data</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/BCC_samples/SU010_Total_Pre_vHealthyAdult&#39;</span><span class="p">,</span>
                                    <span class="n">mtx_file</span> <span class="o">=</span> <span class="s1">&#39;matrix.mtx.gz&#39;</span><span class="p">,</span>
                                    <span class="n">cells_file</span> <span class="o">=</span> <span class="s1">&#39;barcodes.tsv&#39;</span><span class="p">,</span>
                                    <span class="n">features_file</span> <span class="o">=</span> <span class="s1">&#39;features.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">variable_prefix</span> <span class="o">=</span> <span class="s2">&quot;SU010_Total_Pre&quot;</span><span class="p">,</span>
                                    <span class="n">celltype_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span><span class="p">,</span>
                                    <span class="n">add_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">SU010_Total_Pre</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">SU007_Total_Post</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">reference_data</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SU010_Total_Pre</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">assert</span> <span class="n">reference_data</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SU007_Total_Post</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1071 × 890130
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
    var: &#39;selected&#39;
AnnData object with n_obs × n_vars = 666 × 890130
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
    var: &#39;selected&#39;
AnnData object with n_obs × n_vars = 100158 × 890130
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
    var: &#39;selected&#39;
    uns: &#39;cell type_colors&#39;, &#39;major cell type_colors&#39;, &#39;spectral_eigenvalue&#39;, &#39;tissue_colors&#39;
    obsm: &#39;X_umap&#39;
</pre></div></div>
</div>
<p>We first create a dictionary of reference and query datasets</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SU007_Total_Post</span><span class="p">,</span> <span class="n">SU010_Total_Pre</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;total number of query cells: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
total number of query cells: 1737
</pre></div></div>
</div>
<p>Before integration, we need to select features of datasets and prepare for integration</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_features</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">anndata</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
    <span class="n">select_features</span><span class="p">(</span><span class="n">anndata</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">=</span><span class="p">{}</span>
<span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;Atlas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_data</span>
<span class="k">for</span> <span class="n">anndata</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">anndata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">anndata</span>
<span class="n">datasets</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jiang/Dropbox (Partners HealthCare)/Software/ATAC_Annotation_V3/ATAC_Annotation_Package/scATAnno/SnapATAC2_spectral.py:159: ImplicitModificationWarning: Trying to modify attribute `.var` of view, initializing view as actual.
  adata.var[&#34;selected&#34;] = selected_features
/Users/jiang/Dropbox (Partners HealthCare)/Software/ATAC_Annotation_V3/ATAC_Annotation_Package/scATAnno/SnapATAC2_spectral.py:159: ImplicitModificationWarning: Trying to modify attribute `.var` of view, initializing view as actual.
  adata.var[&#34;selected&#34;] = selected_features
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;Atlas&#39;: AnnData object with n_obs × n_vars = 100158 × 890130
     obs: &#39;Unnamed: 0&#39;, &#39;sample&#39;, &#39;replicate&#39;, &#39;logUMI&#39;, &#39;tsse&#39;, &#39;tissue&#39;, &#39;cell type&#39;, &#39;Life stage&#39;, &#39;major cell type&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;
     uns: &#39;cell type_colors&#39;, &#39;major cell type_colors&#39;, &#39;spectral_eigenvalue&#39;, &#39;tissue_colors&#39;
     obsm: &#39;X_umap&#39;,
 &#39;SU007_Total_Post&#39;: AnnData object with n_obs × n_vars = 666 × 890130
     obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;,
 &#39;SU010_Total_Pre&#39;: AnnData object with n_obs × n_vars = 1071 × 890130
     obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;}
</pre></div></div>
</div>
<p>We use SnapATAC2 to integrate the reference atlas and multiple query data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate reference and query data</span>
<span class="n">integrated_adata</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_integrate_multiple</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Compute similarity matrix
Normalization
Perform decomposition
Perform Nystrom extension
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|█████████████████████████████████████████████| 6/6 [05:55&lt;00:00, 59.27s/it]
</pre></div></div>
</div>
<p>Apply harmony to remove batch effects of datasets</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply harmony to remove batch effects</span>
<span class="n">integrated_adata_harmony</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_harmony</span><span class="p">(</span><span class="n">integrated_adata</span><span class="p">,</span> <span class="n">batch_col</span> <span class="o">=</span> <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2023-05-25 14:11:10,406 - harmonypy - INFO - Iteration 1 of 20
2023-05-25 14:11:31,432 - harmonypy - INFO - Iteration 2 of 20
2023-05-25 14:11:52,638 - harmonypy - INFO - Converged after 2 iterations
</pre></div></div>
</div>
<p>Plot UMAP using spectral embeddings</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot UMAP using spectral embeddings</span>
<span class="n">integrated_adata</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_umap</span><span class="p">(</span><span class="n">integrated_adata_harmony</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="s2">&quot;X_spectral_harmony&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set plotting parameters</span>
<span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">defaultPlotting_umap</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">integrated_adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">,</span> <span class="s1">&#39;#228833&#39;</span><span class="p">,</span><span class="s1">&#39;#8c564b&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Integration&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_20_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_20_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">integrated_adata</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tissue</th>
      <th>dataset</th>
      <th>celltypes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>adipose_omentum_SM-CSSD4_1+AAGTCCTTAGGGCTGATATGCT_Atlas</th>
      <td>adipose_omentum_SM-CSSD4</td>
      <td>Atlas</td>
      <td>Mesenchymal</td>
    </tr>
    <tr>
      <th>adipose_omentum_SM-CSSD4_1+AACGACCAAAGGCGTACTTCTA_Atlas</th>
      <td>adipose_omentum_SM-CSSD4</td>
      <td>Atlas</td>
      <td>Mesenchymal</td>
    </tr>
    <tr>
      <th>adipose_omentum_SM-IOBHJ_1+ATACTCGCTTAGCGGCTGAAAC_Atlas</th>
      <td>adipose_omentum_SM-IOBHJ</td>
      <td>Atlas</td>
      <td>Mesenchymal</td>
    </tr>
    <tr>
      <th>adipose_omentum_SM-CSSD4_1+CAGGAAAGCAAAAGGGATGCCA_Atlas</th>
      <td>adipose_omentum_SM-CSSD4</td>
      <td>Atlas</td>
      <td>Mesenchymal</td>
    </tr>
    <tr>
      <th>adipose_omentum_SM-IOBHJ_1+ATGCAGGTAAATAGCTGTGTCT_Atlas</th>
      <td>adipose_omentum_SM-IOBHJ</td>
      <td>Atlas</td>
      <td>Mesenchymal</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#TGGGTTATCCCAGCAG-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#GGGTGTCTCGGGACAA-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#ACCGGGTCATCCCAAA-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#CCCGTTATCTAGCAGT-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#GAACGTTGTTAAGTCC-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
    </tr>
  </tbody>
</table>
<p>101895 rows × 3 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference</span> <span class="o">=</span> <span class="n">integrated_adata</span><span class="p">[</span><span class="n">integrated_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Atlas&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">reference</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypes&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">curate_celltype_names</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypes&quot;</span><span class="p">],</span> <span class="n">atlas</span> <span class="o">=</span> <span class="s2">&quot;HealthyAdult&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;HealthyAdult_reference_palette.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">celltype_palette</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">defaultPlotting_umap</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;celltypes&quot;</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="n">celltype_palette</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Healthy Adult Reference Atlas&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_23_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_23_1.png" />
</div>
</div>
<p>After integration, we want to assign cell types to the query data. First, query cells are assigned labels using K-Nearest neighbors along with KNN-based uncertainty score. Second, query cell labels are corrected using weighted-distance-based uncertainty score. Third, query cells are clustered and annotated at the cluster level.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">integrated_adata</span><span class="p">[</span><span class="n">integrated_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Atlas&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Obtain UMAP coordinates and clusters provided by the original publication. Then Query cells are clustered and annotated at the cluster-level</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">projection_allcells</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s2">&quot;data/BCC_samples/BCC_study_metadata.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">projection_allcells</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">projection_allcells</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">projection_allcells</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">sample_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SU010_Total_Pre&quot;</span><span class="p">,</span> <span class="s2">&quot;SU007_Total_Post&quot;</span><span class="p">]</span>
<span class="n">projection</span> <span class="o">=</span> <span class="n">projection_allcells</span><span class="p">[</span><span class="n">projection_allcells</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sample_names</span><span class="p">)]</span>
<span class="n">query</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">projection</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>UMAP_1</th>
      <th>UMAP_2</th>
      <th>Clusters</th>
      <th>Group</th>
      <th>depth</th>
      <th>FRIP</th>
      <th>Barcodes</th>
      <th>Internal_Name</th>
      <th>Group_Barcode</th>
      <th>true_label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SU007_Total_Post#GGACACCAGCGCACAA-1_SU007_Total_Post</th>
      <td>1.320694</td>
      <td>12.943564</td>
      <td>Cluster14</td>
      <td>SU007_Total_Post</td>
      <td>50427</td>
      <td>0.676443</td>
      <td>GGACACCAGCGCACAA-1</td>
      <td>SU007_Total_Post_57</td>
      <td>SU007_Total_Post#GGACACCAGCGCACAA-1</td>
      <td>Myeloid</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#ACTAGGTGTACCCATA-1_SU007_Total_Post</th>
      <td>5.631482</td>
      <td>13.093065</td>
      <td>Cluster15</td>
      <td>SU007_Total_Post</td>
      <td>45889</td>
      <td>0.580553</td>
      <td>ACTAGGTGTACCCATA-1</td>
      <td>SU007_Total_Post_59</td>
      <td>SU007_Total_Post#ACTAGGTGTACCCATA-1</td>
      <td>Endothelial</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#AGGACGATCGGTCTCT-1_SU007_Total_Post</th>
      <td>1.471412</td>
      <td>-7.473051</td>
      <td>Cluster4</td>
      <td>SU007_Total_Post</td>
      <td>21568</td>
      <td>0.688590</td>
      <td>AGGACGATCGGTCTCT-1</td>
      <td>SU007_Total_Post_60</td>
      <td>SU007_Total_Post#AGGACGATCGGTCTCT-1</td>
      <td>Treg</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GACCAATCATGGGTGA-1_SU007_Total_Post</th>
      <td>-4.932662</td>
      <td>2.046299</td>
      <td>Cluster7</td>
      <td>SU007_Total_Post</td>
      <td>25402</td>
      <td>0.714097</td>
      <td>GACCAATCATGGGTGA-1</td>
      <td>SU007_Total_Post_61</td>
      <td>SU007_Total_Post#GACCAATCATGGGTGA-1</td>
      <td>Memory CD8 T</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GCTCGAGAGTAATGTG-1_SU007_Total_Post</th>
      <td>-4.171803</td>
      <td>3.467478</td>
      <td>Cluster7</td>
      <td>SU007_Total_Post</td>
      <td>6544</td>
      <td>0.714318</td>
      <td>GCTCGAGAGTAATGTG-1</td>
      <td>SU007_Total_Post_62</td>
      <td>SU007_Total_Post#GCTCGAGAGTAATGTG-1</td>
      <td>Memory CD8 T</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>We first assign cell types based on KNN and compute KNN-based uncertainty score</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform KNN assignment</span>
<span class="n">query_KNN</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_KNN_assign</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">reference_label_col</span><span class="o">=</span><span class="n">reference_label_col</span><span class="p">,</span> <span class="n">low_dim_col</span><span class="o">=</span><span class="n">use_rep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Query cells are assigned high weighted distance-based uncertainty score if their distances to the assigned reference cell type centroid are greater than 90 percentile. Query cells with uncertainty score greater than 0.2 are annotated as unknown.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform weighted-distance based assignment</span>
<span class="n">distance_threshold</span> <span class="o">=</span> <span class="mi">90</span>
<span class="n">uncertainty_threshold</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">reference_label_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span>
<span class="n">use_rep</span> <span class="o">=</span> <span class="s2">&quot;X_spectral_harmony&quot;</span>
<span class="n">atlas</span> <span class="o">=</span> <span class="s2">&quot;HealthyAdult&quot;</span>
<span class="n">query_distance</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_distance_assign</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">query_KNN</span><span class="p">,</span> <span class="n">reference_label_col</span><span class="o">=</span><span class="n">reference_label_col</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="o">=</span><span class="n">distance_threshold</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">uncertainty_threshold</span><span class="o">=</span><span class="n">uncertainty_threshold</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="n">use_rep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We then project query cells into the same UMAP coordinates as original publication for better comparisons, and perform cluster-level assignment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_distance</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_umap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query_distance</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;UMAP_1&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP_2&quot;</span><span class="p">]])</span>
<span class="n">query_annotated</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_cluster_assign</span><span class="p">(</span><span class="n">query_distance</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="n">use_rep</span><span class="p">,</span> <span class="n">cluster_col</span> <span class="o">=</span> <span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">UMAP</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">query_annotated</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 1737 × 890130
    obs: &#39;tissue&#39;, &#39;dataset&#39;, &#39;celltypes&#39;, &#39;uncertainty_score_step1&#39;, &#39;pred_y&#39;, &#39;uncertainty_score_step2&#39;, &#39;Uncertainty_Score&#39;, &#39;1.knn-based_celltype&#39;, &#39;2.corrected_celltype&#39;, &#39;UMAP_1&#39;, &#39;UMAP_2&#39;, &#39;Clusters&#39;, &#39;Group&#39;, &#39;depth&#39;, &#39;FRIP&#39;, &#39;Barcodes&#39;, &#39;Internal_Name&#39;, &#39;Group_Barcode&#39;, &#39;true_label&#39;, &#39;cluster_annotation&#39;
    uns: &#39;dataset_colors&#39;
    obsm: &#39;X_spectral&#39;, &#39;X_spectral_harmony&#39;, &#39;X_umap&#39;, &#39;kernel_distance&#39;, &#39;distance&#39;, &#39;indices&#39;, &#39;neighbors_labels&#39;
</pre></div></div>
</div>
<p>Compare annotation results from scATAnno and the origional publication</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">query_annotated</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;true_label&#39;</span><span class="p">,</span> <span class="s2">&quot;cluster_annotation&quot;</span><span class="p">,</span> <span class="s1">&#39;Uncertainty_Score&#39;</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Annotation Published in Satpathy et al.&quot;</span><span class="p">,</span><span class="s2">&quot;scATAnno Annotation&quot;</span><span class="p">],</span> <span class="n">legend_loc</span> <span class="o">=</span> <span class="s2">&quot;on data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: The title list is shorter than the number of panels. Using &#39;color&#39; value instead for some plots.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_35_2.png" src="../_images/tutorials_demo_BCC_multiple_samples_35_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">immune_cells</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">query_annotated</span><span class="p">[</span><span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cluster_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Immune Cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">immune_cells</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                                                   0
0  SU007_Total_Post#TCGTTCGAGGTTCTCA-1_SU007_Tota...
1  SU007_Total_Post#GCAACCGAGAAGAGTG-1_SU007_Tota...
2  SU007_Total_Post#GTGTCAAGTTAGTAGA-1_SU007_Tota...
3  SU007_Total_Post#CTTGTCGAGCGAGCTA-1_SU007_Tota...
4  SU007_Total_Post#GCAGCTGCATTCGTCC-1_SU007_Tota...
</pre></div></div>
</div>
</section>
<section id="Part-II:-Second-round-annotation---Apply-BCC-TIL-reference-atlas-to-BCC-immune-cells">
<h2>Part II: Second round annotation - Apply BCC TIL reference atlas to BCC immune cells<a class="headerlink" href="#Part-II:-Second-round-annotation---Apply-BCC-TIL-reference-atlas-to-BCC-immune-cells" title="Permalink to this heading"></a></h2>
<p>Download TIL reference data</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !wget &quot;https://www.dropbox.com/s/ky4jezsj3pf2qwi/BCC_TIL_reference_atlas_final.h5ad?dl=1&quot;</span>
</pre></div>
</div>
</div>
<p>In the second round annotation, we apply BCC TIL reference atlas to the immune cells identified from the first round. Repeat the integration process. This time we use BCC TIL as reference, and use BCC query data with TIL reference peak as feature input. Reference atlas is stored as h5ad AnnData in the data directory; query data is imported as MTX and TSV files from QuickATAC output.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference_data_path</span> <span class="o">=</span> <span class="s2">&quot;data/Reference/BCC_TIL_reference_atlas_final.h5ad&quot;</span>
<span class="n">reference_data</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">load_reference_data</span><span class="p">(</span><span class="n">reference_data_path</span><span class="p">)</span>
<span class="n">SU007_Total_Post</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">import_query_data</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/BCC_samples/SU007_Total_Post_vBCC&#39;</span><span class="p">,</span>
                                    <span class="n">mtx_file</span> <span class="o">=</span> <span class="s1">&#39;matrix.mtx.gz&#39;</span><span class="p">,</span>
                                    <span class="n">cells_file</span> <span class="o">=</span> <span class="s1">&#39;barcodes.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">features_file</span> <span class="o">=</span> <span class="s1">&#39;features.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">variable_prefix</span> <span class="o">=</span> <span class="s2">&quot;SU007_Total_Post&quot;</span><span class="p">,</span>
                                    <span class="n">celltype_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span><span class="p">,</span>
                                    <span class="n">add_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">SU010_Total_Pre</span> <span class="o">=</span> <span class="n">scATAnno_preprocess</span><span class="o">.</span><span class="n">import_query_data</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;data/BCC_samples/SU010_Total_Pre_vBCC&#39;</span><span class="p">,</span>
                                    <span class="n">mtx_file</span> <span class="o">=</span> <span class="s1">&#39;matrix.mtx.gz&#39;</span><span class="p">,</span>
                                    <span class="n">cells_file</span> <span class="o">=</span> <span class="s1">&#39;barcodes.tsv&#39;</span><span class="p">,</span>
                                    <span class="n">features_file</span> <span class="o">=</span> <span class="s1">&#39;features.tsv.gz&#39;</span><span class="p">,</span>
                                    <span class="n">variable_prefix</span> <span class="o">=</span> <span class="s2">&quot;SU010_Total_Pre&quot;</span><span class="p">,</span>
                                    <span class="n">celltype_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span><span class="p">,</span>
                                    <span class="n">add_metrics</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SU007_Total_Post</span><span class="p">,</span> <span class="n">SU010_Total_Pre</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of query cells: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Total number of query cells: 1737
</pre></div></div>
</div>
<p>Select the immune cells from first round annotation</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">immune_cells</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">immune_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">immune_cells</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_SU&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">immune_cells</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">immune_cells</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SU007_Total_Post#TCGTTCGAGGTTCTCA-1</th>
      <td>SU007_Total_Post#TCGTTCGAGGTTCTCA-1_SU007_Tota...</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GCAACCGAGAAGAGTG-1</th>
      <td>SU007_Total_Post#GCAACCGAGAAGAGTG-1_SU007_Tota...</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GTGTCAAGTTAGTAGA-1</th>
      <td>SU007_Total_Post#GTGTCAAGTTAGTAGA-1_SU007_Tota...</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#CTTGTCGAGCGAGCTA-1</th>
      <td>SU007_Total_Post#CTTGTCGAGCGAGCTA-1_SU007_Tota...</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GCAGCTGCATTCGTCC-1</th>
      <td>SU007_Total_Post#GCAGCTGCATTCGTCC-1_SU007_Tota...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[133]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_list_use</span> <span class="o">=</span> <span class="n">data_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_list_use</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_list_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">data_list_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_list_use</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">data_list_use</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">immune_cells</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">data_list_use</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total immune cells: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list_use</span><span class="p">])))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SU007_Total_Post
View of AnnData object with n_obs × n_vars = 618 × 344492
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
    var: &#39;selected&#39;
SU010_Total_Pre
View of AnnData object with n_obs × n_vars = 188 × 344492
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
    var: &#39;selected&#39;
Total immune cells: 806
</pre></div></div>
</div>
<p>We use SnapATAC2 to integrate the reference atlas and multiple query data</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">anndata</span> <span class="ow">in</span> <span class="n">data_list_use</span><span class="p">:</span>
    <span class="n">select_features</span><span class="p">(</span><span class="n">anndata</span><span class="p">)</span>
<span class="n">select_features</span><span class="p">(</span><span class="n">reference_data</span><span class="p">)</span>

<span class="n">datasets</span><span class="o">=</span><span class="p">{}</span>
<span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;Atlas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_data</span>
<span class="k">for</span> <span class="n">anndata</span> <span class="ow">in</span> <span class="n">data_list_use</span><span class="p">:</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">anndata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;dataset&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">datasets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">anndata</span>
<span class="n">datasets</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/jiang/Dropbox (Partners HealthCare)/Software/ATAC_Annotation_V3/ATAC_Annotation_Package/scATAnno/SnapATAC2_spectral.py:159: ImplicitModificationWarning: Trying to modify attribute `.var` of view, initializing view as actual.
  adata.var[&#34;selected&#34;] = selected_features
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;Atlas&#39;: AnnData object with n_obs × n_vars = 22008 × 344492
     obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;
     uns: &#39;Group_colors&#39;, &#39;celltypes_colors&#39;, &#39;spectral_eigenvalue&#39;, &#39;true_label_colors&#39;
     obsm: &#39;X_spectral&#39;, &#39;X_umap&#39;,
 &#39;SU007_Total_Post&#39;: AnnData object with n_obs × n_vars = 618 × 344492
     obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;,
 &#39;SU010_Total_Pre&#39;: AnnData object with n_obs × n_vars = 188 × 344492
     obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;
     var: &#39;selected&#39;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Integrate reference and query data</span>
<span class="n">integrated_adata</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_integrate_multiple</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Compute similarity matrix
Normalization
Perform decomposition
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply harmony to remove batch effects</span>
<span class="n">integrated_adata_harmony</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_harmony</span><span class="p">(</span><span class="n">integrated_adata</span><span class="p">,</span> <span class="n">batch_col</span> <span class="o">=</span> <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2023-05-25 15:23:46,290 - harmonypy - INFO - Iteration 1 of 20
2023-05-25 15:23:49,706 - harmonypy - INFO - Iteration 2 of 20
2023-05-25 15:23:53,264 - harmonypy - INFO - Iteration 3 of 20
2023-05-25 15:23:56,800 - harmonypy - INFO - Iteration 4 of 20
2023-05-25 15:24:00,334 - harmonypy - INFO - Iteration 5 of 20
2023-05-25 15:24:03,925 - harmonypy - INFO - Iteration 6 of 20
2023-05-25 15:24:07,365 - harmonypy - INFO - Iteration 7 of 20
2023-05-25 15:24:11,058 - harmonypy - INFO - Converged after 7 iterations
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[137]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot UMAP using spectral embeddings</span>
<span class="n">integrated_adata</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_umap</span><span class="p">(</span><span class="n">integrated_adata_harmony</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="s2">&quot;X_spectral_harmony&quot;</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[138]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set plotting parameters</span>
<span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">defaultPlotting_umap</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">integrated_adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#cccccc&#39;</span><span class="p">,</span> <span class="s1">&#39;#228833&#39;</span><span class="p">,</span><span class="s1">&#39;#8c564b&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Integration&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_51_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_51_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[145]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference</span> <span class="o">=</span> <span class="n">integrated_adata</span><span class="p">[</span><span class="n">integrated_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Atlas&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">reference</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypes&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">curate_celltype_names</span><span class="p">(</span><span class="n">reference</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypes&quot;</span><span class="p">],</span> <span class="n">atlas</span> <span class="o">=</span> <span class="s2">&quot;TIL&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[144]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;TIL_reference_palette.pickle&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
    <span class="n">celltype_palette</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">scATAnno_plotting</span><span class="o">.</span><span class="n">defaultPlotting_umap</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;celltypes&quot;</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="n">celltype_palette</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;TIL Reference Atlas&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_53_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_53_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[146]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">integrated_adata</span><span class="p">[</span><span class="n">integrated_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;dataset&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Atlas&quot;</span><span class="p">,:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[147]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">projection_allcells</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s2">&quot;data/BCC_samples/BCC_study_metadata.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">projection_allcells</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">projection_allcells</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">projection_allcells</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">projection_allcells</span><span class="p">[</span><span class="s2">&quot;true_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">projection_allcells</span><span class="p">[</span><span class="s2">&quot;true_label&quot;</span><span class="p">]]</span>
<span class="n">sample_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;SU010_Total_Pre&quot;</span><span class="p">,</span> <span class="s2">&quot;SU007_Total_Post&quot;</span><span class="p">]</span>
<span class="n">projection</span> <span class="o">=</span> <span class="n">projection_allcells</span><span class="p">[</span><span class="n">projection_allcells</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sample_names</span><span class="p">)]</span>
<span class="n">query</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">projection</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">query</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[147]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>celltypes</th>
      <th>tissue</th>
      <th>dataset</th>
      <th>UMAP_1</th>
      <th>UMAP_2</th>
      <th>Clusters</th>
      <th>Group</th>
      <th>depth</th>
      <th>FRIP</th>
      <th>Barcodes</th>
      <th>Internal_Name</th>
      <th>Group_Barcode</th>
      <th>true_label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SU007_Total_Post#TCGTTCGAGGTTCTCA-1_SU007_Total_Post</th>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>2.118399</td>
      <td>-6.020474</td>
      <td>Cluster4</td>
      <td>SU007_Total_Post</td>
      <td>10159</td>
      <td>0.722758</td>
      <td>TCGTTCGAGGTTCTCA-1</td>
      <td>SU007_Total_Post_312</td>
      <td>SU007_Total_Post#TCGTTCGAGGTTCTCA-1</td>
      <td>Treg</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GCAACCGAGAAGAGTG-1_SU007_Total_Post</th>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>2.138090</td>
      <td>-8.092027</td>
      <td>Cluster4</td>
      <td>SU007_Total_Post</td>
      <td>12455</td>
      <td>0.715857</td>
      <td>GCAACCGAGAAGAGTG-1</td>
      <td>SU007_Total_Post_1</td>
      <td>SU007_Total_Post#GCAACCGAGAAGAGTG-1</td>
      <td>Treg</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GTGTCAAGTTAGTAGA-1_SU007_Total_Post</th>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>0.018025</td>
      <td>-1.757976</td>
      <td>Cluster1</td>
      <td>SU007_Total_Post</td>
      <td>9101</td>
      <td>0.621910</td>
      <td>GTGTCAAGTTAGTAGA-1</td>
      <td>SU007_Total_Post_468</td>
      <td>SU007_Total_Post#GTGTCAAGTTAGTAGA-1</td>
      <td>Naive CD4 T</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#CTTGTCGAGCGAGCTA-1_SU007_Total_Post</th>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>-1.315312</td>
      <td>1.582670</td>
      <td>Cluster5</td>
      <td>SU007_Total_Post</td>
      <td>22287</td>
      <td>0.669695</td>
      <td>CTTGTCGAGCGAGCTA-1</td>
      <td>SU007_Total_Post_3</td>
      <td>SU007_Total_Post#CTTGTCGAGCGAGCTA-1</td>
      <td>Naive CD8 T</td>
    </tr>
    <tr>
      <th>SU007_Total_Post#GCAGCTGCATTCGTCC-1_SU007_Total_Post</th>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>SU007_Total_Post</td>
      <td>0.688227</td>
      <td>-1.430185</td>
      <td>Cluster1</td>
      <td>SU007_Total_Post</td>
      <td>22482</td>
      <td>0.693866</td>
      <td>GCAGCTGCATTCGTCC-1</td>
      <td>SU007_Total_Post_4</td>
      <td>SU007_Total_Post#GCAGCTGCATTCGTCC-1</td>
      <td>Naive CD4 T</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#CCAGATAAGTACGCGA-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>-3.657552</td>
      <td>2.379094</td>
      <td>Cluster7</td>
      <td>SU010_Total_Pre</td>
      <td>6428</td>
      <td>0.583852</td>
      <td>CCAGATAAGTACGCGA-1</td>
      <td>SU010_Total_Pre_1057</td>
      <td>SU010_Total_Pre#CCAGATAAGTACGCGA-1</td>
      <td>Memory CD8 T</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#ACAGGCCTCAAGAGAT-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>-3.117948</td>
      <td>1.990111</td>
      <td>Cluster5</td>
      <td>SU010_Total_Pre</td>
      <td>3820</td>
      <td>0.529188</td>
      <td>ACAGGCCTCAAGAGAT-1</td>
      <td>SU010_Total_Pre_1058</td>
      <td>SU010_Total_Pre#ACAGGCCTCAAGAGAT-1</td>
      <td>Naive CD8 T</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#TGGGTTATCCCAGCAG-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>-1.875685</td>
      <td>0.338385</td>
      <td>Cluster5</td>
      <td>SU010_Total_Pre</td>
      <td>4741</td>
      <td>0.469099</td>
      <td>TGGGTTATCCCAGCAG-1</td>
      <td>SU010_Total_Pre_1061</td>
      <td>SU010_Total_Pre#TGGGTTATCCCAGCAG-1</td>
      <td>Naive CD8 T</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#GGGTGTCTCGGGACAA-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>-4.008999</td>
      <td>16.443800</td>
      <td>Cluster13</td>
      <td>SU010_Total_Pre</td>
      <td>6619</td>
      <td>0.599940</td>
      <td>GGGTGTCTCGGGACAA-1</td>
      <td>SU010_Total_Pre_1064</td>
      <td>SU010_Total_Pre#GGGTGTCTCGGGACAA-1</td>
      <td>Plasma B</td>
    </tr>
    <tr>
      <th>SU010_Total_Pre#CCCGTTATCTAGCAGT-1_SU010_Total_Pre</th>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>SU010_Total_Pre</td>
      <td>-4.014687</td>
      <td>1.344591</td>
      <td>Cluster10</td>
      <td>SU010_Total_Pre</td>
      <td>32230</td>
      <td>0.209680</td>
      <td>CCCGTTATCTAGCAGT-1</td>
      <td>SU010_Total_Pre_1068</td>
      <td>SU010_Total_Pre#CCCGTTATCTAGCAGT-1</td>
      <td>NK1</td>
    </tr>
  </tbody>
</table>
<p>806 rows × 13 columns</p>
</div></div>
</div>
<p>We first assign cell types based on KNN and compute KNN-based uncertainty score</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[149]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform KNN assignment</span>
<span class="n">reference_label_col</span> <span class="o">=</span> <span class="s2">&quot;celltypes&quot;</span>
<span class="n">use_rep</span> <span class="o">=</span> <span class="s2">&quot;X_spectral_harmony&quot;</span>
<span class="n">query_KNN</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_KNN_assign</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">reference_label_col</span><span class="o">=</span><span class="n">reference_label_col</span><span class="p">,</span> <span class="n">low_dim_col</span><span class="o">=</span><span class="n">use_rep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Because we are annotating TIL subtypes, we adopt more loose threshold cutoffs to annotate query cells. Query cells are assigned high weighted distance-based uncertainty score if their distances to the assigned reference cell type centroid are greater than 95 percentile. Query cells with uncertainty score greater than 0.5 are annotated as unknown.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[150]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Perform weighted-distance based assignment</span>
<span class="n">distance_threshold</span> <span class="o">=</span> <span class="mi">95</span>
<span class="n">uncertainty_threshold</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">atlas</span> <span class="o">=</span> <span class="s2">&quot;HealthyAdult&quot;</span>
<span class="n">query_distance</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_distance_assign</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">query_KNN</span><span class="p">,</span> <span class="n">reference_label_col</span><span class="o">=</span><span class="n">reference_label_col</span><span class="p">,</span> <span class="n">distance_threshold</span><span class="o">=</span><span class="n">distance_threshold</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">,</span> <span class="n">uncertainty_threshold</span><span class="o">=</span><span class="n">uncertainty_threshold</span><span class="p">,</span> <span class="n">use_rep</span> <span class="o">=</span> <span class="n">use_rep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We then project query cells into the same UMAP coordinates as original publication for better comparisons, and perform cluster-level assignment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[151]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query_distance</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_umap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">query_distance</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;UMAP_1&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP_2&quot;</span><span class="p">]])</span>
<span class="n">query_annotated</span> <span class="o">=</span> <span class="n">scATAnno_assignment</span><span class="o">.</span><span class="n">scATAnno_cluster_assign</span><span class="p">(</span><span class="n">query_distance</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="n">use_rep</span><span class="p">,</span> <span class="n">cluster_col</span> <span class="o">=</span> <span class="s2">&quot;Clusters&quot;</span><span class="p">,</span> <span class="n">UMAP</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">query_annotated</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[151]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 806 × 344492
    obs: &#39;celltypes&#39;, &#39;tissue&#39;, &#39;dataset&#39;, &#39;UMAP_1&#39;, &#39;UMAP_2&#39;, &#39;Clusters&#39;, &#39;Group&#39;, &#39;depth&#39;, &#39;FRIP&#39;, &#39;Barcodes&#39;, &#39;Internal_Name&#39;, &#39;Group_Barcode&#39;, &#39;true_label&#39;, &#39;uncertainty_score_step1&#39;, &#39;pred_y&#39;, &#39;uncertainty_score_step2&#39;, &#39;Uncertainty_Score&#39;, &#39;1.knn-based_celltype&#39;, &#39;2.corrected_celltype&#39;, &#39;cluster_annotation&#39;
    uns: &#39;dataset_colors&#39;
    obsm: &#39;X_spectral&#39;, &#39;X_spectral_harmony&#39;, &#39;X_umap&#39;, &#39;kernel_distance&#39;, &#39;distance&#39;, &#39;indices&#39;, &#39;neighbors_labels&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[152]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">query_annotated</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;true_label&#39;</span><span class="p">,</span> <span class="s2">&quot;cluster_annotation&quot;</span><span class="p">,</span> <span class="s1">&#39;Uncertainty_Score&#39;</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Annotation Published in Satpathy et al.&quot;</span><span class="p">,</span><span class="s2">&quot;scATAnno Annotation&quot;</span><span class="p">],</span> <span class="n">legend_loc</span> <span class="o">=</span> <span class="s2">&quot;on data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: The title list is shorter than the number of panels. Using &#39;color&#39; value instead for some plots.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_62_2.png" src="../_images/tutorials_demo_BCC_multiple_samples_62_2.png" />
</div>
</div>
<p>Finally, compare the annotation results between scATAnno and original publication.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[175]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outcomes2</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cluster_annotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;cluster_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;true_label&quot;</span><span class="p">]:</span>
        <span class="n">outcomes2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Consistent&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s2">&quot;cluster_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
        <span class="n">outcomes2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outcomes2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Inconsistent&quot;</span><span class="p">)</span>

<span class="n">query_annotated</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;outcomes2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outcomes2</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">query_annotated</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;outcomes2&quot;</span><span class="p">,</span> <span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span><span class="s1">&#39;#279e68&#39;</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Comparison&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/scanpy/plotting/_tools/scatterplots.py:392: UserWarning: No data for colormapping provided via &#39;c&#39;. Parameters &#39;cmap&#39; will be ignored
  cax = scatter(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_64_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_64_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[180]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_query</span> <span class="o">=</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">variable_col</span> <span class="o">=</span> <span class="s2">&quot;true_label&quot;</span>
<span class="n">outcome_col</span> <span class="o">=</span> <span class="s2">&quot;outcomes2&quot;</span>
<span class="n">listdict</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">variable_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    <span class="n">tmp_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">outcome_col</span><span class="p">]):</span>
        <span class="n">tmp_dict</span><span class="p">[</span><span class="n">pt</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">variable_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">][</span><span class="n">outcome_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">pt</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">variable_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">])</span>
    <span class="n">tmp_dict</span><span class="p">[</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ct</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s1">)&#39;</span>
    <span class="n">tmp_dict</span><span class="p">[</span><span class="s1">&#39;n_cells&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata_query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">variable_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct</span><span class="p">])</span>
    <span class="n">listdict</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_dict</span><span class="p">)</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">listdict</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;ct&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;ct&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;n_cells&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;barh&#39;</span><span class="p">,</span> <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#ff7f0e&#39;</span><span class="p">,</span><span class="s1">&#39;#279e68&#39;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;cell numbers&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/79/yz2sgggd11n9c7kj2nws4w700000gp/T/ipykernel_5654/2520740504.py:24: UserWarning: FixedFormatter should only be used together with FixedLocator
  ax.set_xticklabels(ax.get_xticklabels(), fontsize=15)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_65_1.png" src="../_images/tutorials_demo_BCC_multiple_samples_65_1.png" />
</div>
</div>
<p>Compute accuracy and F1 scores</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[183]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">query_annotated</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">paper_anno_col</span><span class="o">=</span><span class="s2">&quot;true_label&quot;</span>
<span class="n">cluster_anno_col</span> <span class="o">=</span> <span class="s2">&quot;cluster_annotation&quot;</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">classification_report</span>
<span class="n">report</span> <span class="o">=</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">paper_anno_col</span><span class="p">],</span>
                                       <span class="n">y_pred</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_anno_col</span><span class="p">],</span>
                                       <span class="n">output_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#Also generate a confusion matrix</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">paper_anno_col</span><span class="p">],</span>
                                       <span class="n">y_pred</span><span class="o">=</span><span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cluster_anno_col</span><span class="p">],)</span>

<span class="n">FP</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
<span class="n">FN</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
<span class="n">TP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
<span class="n">TN</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">FP</span> <span class="o">+</span> <span class="n">FN</span> <span class="o">+</span> <span class="n">TP</span><span class="p">)</span>
<span class="n">class_spec</span> <span class="o">=</span> <span class="n">TN</span><span class="o">/</span><span class="p">(</span><span class="n">TN</span><span class="o">+</span><span class="n">FP</span><span class="p">)</span>

<span class="n">perfdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;precision&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;recall&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;f1_score&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;support&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;specificity&#39;</span><span class="p">])</span>

<span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">report</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1">#we don&#39;t use accuracy so skip it</span>
    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span><span class="s1">&#39;accuracy&#39;</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">perflist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">perflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">val2</span> <span class="ow">in</span> <span class="n">val</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">perflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">class_spec</span><span class="p">):</span>
        <span class="n">perflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perflist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_spec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">perfdf</span><span class="o">=</span><span class="n">perfdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">perflist</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">perfdf</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Precision and F-score are ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Recall and F-score are ill-defined and being set to 0.0 in labels with no true samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Precision and F-score are ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Recall and F-score are ill-defined and being set to 0.0 in labels with no true samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Precision and F-score are ill-defined and being set to 0.0 in labels with no predicted samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
/opt/anaconda3/lib/python3.9/site-packages/sklearn/metrics/_classification.py:1344: UndefinedMetricWarning: Recall and F-score are ill-defined and being set to 0.0 in labels with no true samples. Use `zero_division` parameter to control this behavior.
  _warn_prf(average, modifier, msg_start, len(result))
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">perfdf</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>class</th>
      <th>precision</th>
      <th>recall</th>
      <th>f1_score</th>
      <th>support</th>
      <th>specificity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>B</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>25</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>CD8 TEx</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>23</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Effector CD8 T</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>48</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Memory CD8 T</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>147</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Myeloid</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>21</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>NK1</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>29</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>NK2</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>16</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Naive CD4 T</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>140</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Naive CD8 T</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>51</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Plasma B</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>118</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>Tfh</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>44</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>Th1</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>23</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>Th17</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>19</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>Treg</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
      <td>102</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>unknown</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0</td>
      <td>0.971464</td>
    </tr>
    <tr>
      <th>15</th>
      <td>macro avg</td>
      <td>0.866667</td>
      <td>0.866667</td>
      <td>0.866667</td>
      <td>806</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>weighted avg</td>
      <td>0.971464</td>
      <td>0.971464</td>
      <td>0.971464</td>
      <td>806</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[186]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Accuracy</span>
<span class="kn">from</span> <span class="nn">scATAnno</span> <span class="kn">import</span> <span class="n">scATAnno_evaluation</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cell_accr</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">celltype_of_interest</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">paper_anno_col</span><span class="p">]):</span>
    <span class="n">true_cells</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">paper_anno_col</span><span class="p">]</span><span class="o">==</span><span class="n">celltype_of_interest</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="n">accr</span> <span class="o">=</span> <span class="n">scATAnno_evaluation</span><span class="o">.</span><span class="n">compute_accuracy</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">true_cells</span><span class="p">,</span><span class="n">paper_anno_col</span><span class="p">],</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">true_cells</span><span class="p">,</span><span class="n">cluster_anno_col</span><span class="p">])</span>
    <span class="n">cell_accr</span><span class="p">[</span><span class="n">celltype_of_interest</span><span class="p">]</span> <span class="o">=</span> <span class="n">accr</span>

<span class="n">cell_level_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cell_accr</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cell_accr</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="n">cell_level_df</span> <span class="o">=</span> <span class="n">cell_level_df</span><span class="o">.</span><span class="n">T</span>
<span class="n">cell_level_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]</span>
<span class="n">cell_level_df</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[186]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>accuracy</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>CD8 TEx</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Effector CD8 T</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Memory CD8 T</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Myeloid</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>NK1</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>NK2</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Naive CD4 T</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Naive CD8 T</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Plasma B</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Tfh</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Th1</th>
      <td>0.0</td>
    </tr>
    <tr>
      <th>Th17</th>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Treg</th>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">cell_level_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">perfdf</span><span class="p">[</span><span class="n">perfdf</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;weighted avg&quot;</span><span class="p">][</span><span class="s2">&quot;f1_score&quot;</span><span class="p">])])</span>

<span class="n">overallscore</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;Weighted F1&#39;</span><span class="p">,],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                             <span class="p">)</span>

<span class="n">overallscore</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Accuracy</th>
      <td>0.928571</td>
    </tr>
    <tr>
      <th>Weighted F1</th>
      <td>0.971464</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[189]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">overallscore</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="n">overallscore</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">capsize</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">dodge</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Classification Performance&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_demo_BCC_multiple_samples_71_0.png" src="../_images/tutorials_demo_BCC_multiple_samples_71_0.png" />
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Yijia Jiang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>